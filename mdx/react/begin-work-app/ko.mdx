export const title = 'ë‚˜ë¨¸ì§€ Fiberë¥¼ ì¡°ë¦½í•˜ëŠ” ê³¼ì •'

## ë³µìŠµ

ì ì‹œ ë³µìŠµì„ í•´ë³´ì. ì•„ë˜ App ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë˜ëŠ” ê³¼ì •ì„ ë”°ë¼ê°€ê³  ìˆì—ˆë‹¤. 

```jsx
import { useState } from 'react';

function Link() {
  return <a href="https://yeolyi.com">yeolyi.com</a>;
}

export default function App() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>
        <Link />
        <br />
        <button onClick={() => setCount((count) => count + 1)}>
          click me - {count}
        </button>
      </p>
    </div>
  );
}
```

ë¦¬ì•¡íŠ¸ ë Œë”ë§ ê³¼ì •ì€ ìƒˆë¡œìš´ Fiber íŠ¸ë¦¬ë¥¼ ë§Œë“¤ì–´ë‚´ëŠ” ê³¼ì •ì´ë‹¤. `workInProgress` ë³€ìˆ˜ëŠ” ìƒˆë¡œìš´ Fiber íŠ¸ë¦¬ì—ì„œ í˜„ì¬ ì‘ì—…ì¤‘ì¸ Fiberë¥¼ ê°€ë¦¬í‚¨ë‹¤. `current`ëŠ” ê¸°ì¡´ Fiber íŠ¸ë¦¬ì—ì„œ `workInProgress`ì— ëŒ€ì‘ë˜ëŠ” ë…¸ë“œë¥¼ ê°€ë¦¬í‚¨ë‹¤. 

`performUnitOfWork`ëŠ” `workInProgress`ë¥¼ ì¸ìë¡œ ë°›ì•„ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©° ë¦¬í„´í•  ì‹œì ì— `workInProgress`ëŠ” ë‹¤ìŒ ì‘ì—…í•´ì•¼í•  Fiber ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤. 

```js
// The work loop is an extremely hot path. Tell Closure not to inline it.
/** @noinline */
function workLoopSync() {
  // Perform work without checking if we need to yield between fiber.
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}
```

ì´ˆê¸° ë Œë”ë§ ì‹œì— `current`ëŠ” ReactDOM.createRoot ì‹œì ì— ë§Œë“¤ì–´ì§„ HostRootFiberë¥¼ ê°€ë¦¬í‚¤ë©° `workInProgress`ëŠ” `prepareFreshStack`ì—ì„œ ë§Œë“¤ì–´ì§„ HostRootFiberë¥¼ ê°€ë¦¬í‚¨ë‹¤. 

**ë”°ë¼ì„œ ì²« `performUnitOfWork`ì˜ ì¸ìë¡œëŠ” `HostRootFiber`ê°€ ê±´ë„¤ì§„ë‹¤. **

ì´í›„ `reconcileChildFibers`ì—ì„œëŠ” `workInProgress`ë¥¼ ì²˜ë¦¬í•˜ë©° `<App/>`ì„ ë‚˜íƒ€ë‚´ëŠ” Fiberë¥¼ ë§Œë“¤ê³  ì´ë¥¼ `workinProgress`ì˜ child ë…¸ë“œë¡œ ì„¤ì •í•œë‹¤. ì´í›„ ì‘ì—…ì„ ë§ˆì¹˜ë©´ `workInProgress = workInProgress.child`ë¡œ ì„¤ì •ëœë‹¤. 

**ë”°ë¼ì„œ ë‘ë²ˆì§¸ `performUnitOfWork`ì˜ ì¸ìë¡œëŠ” `<App/>`ì„ ë‚˜íƒ€ë‚´ëŠ” Fiberê°€ ê±´ë„¤ì§„ë‹¤.**

## performUnitOfWork

```js
function performUnitOfWork(unitOfWork: Fiber): void {
  // [!code highlight:3]
  // `<App/>`ì— ëŒ€ì‘ë˜ëŠ” ê¸°ì¡´ FiberëŠ” ì—†ë‹¤.
  // ì¦‰ currentëŠ” nullì´ë‹¤.
  const current = unitOfWork.alternate;

  const next = beginWork(current, unitOfWork, entangledRenderLanes);

  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    // If this doesn't spawn new work, complete the current work.
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }
}
```

unitOfWork = workInProgress = `<App/>` Fiber ì„ì„ ê¸°ì–µí•˜ì. 

## beginWork

ì´ì „ì— ë§Œë“  Appì„ ë‚˜íƒ€ë‚´ëŠ” FiberëŠ” `FunctionComponent tag(0)`ë¥¼ ê°€ì§€ê³  ìˆë‹¤. ë”°ë¼ì„œ ì´ë²ˆì—ëŠ” HostRootê°€ ì•„ë‹Œ FunctionComponent tagì— ëŒ€í•œ ë¶„ê¸°ë¡œ ë¹ ì§„ë‹¤. 

```js
function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
  ...
  switch (workInProgress.tag) {
    case FunctionComponent: {
      const Component = workInProgress.type;
      const unresolvedProps = workInProgress.pendingProps;
      const resolvedProps =
        disableDefaultPropsExceptForClasses ||
        workInProgress.elementType === Component
          ? unresolvedProps
          : resolveDefaultPropsOnNonClassComponent(Component, unresolvedProps);
      // [!code highlight:7]
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        resolvedProps,
        renderLanes,
      );
    }
    ...
  }
}
```

ìš°ë¦¬ê°€ ë§Œë“  ì»´í¬ë„ŒíŠ¸ í•¨ìˆ˜ê°€ `Component`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë“±ì¥í•œë‹¤! í•´ë‹¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ í•„ìš”í•œ propë„ ì¶”ì¶œë˜ì—ˆë‹¤. í”„ë¦°íŠ¸ë¥¼ ì°ì–´ë³´ë©´ ê°ê° `App`, `{}`ì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## updateFunctionComponent

`reconcileChildren`ì´ í˜¸ì¶œë˜ëŠ”ê±´ `updateHostRoot`ì™€ ë™ì¼í•˜ì§€ë§Œ ì—…ë°ì´íŠ¸ íì—ì„œ ìì‹ Elementë¥¼ ì–»ì–´ë‚¸ ì§€ë‚œë²ˆê³¼ ë‹¤ë¥´ê²Œ ì´ë²ˆì—ëŠ” `renderWithHooks`ì—ì„œ `nextChildren`ì„ ì–»ì–´ë‚¸ë‹¤. 

```js
function updateFunctionComponent(
  // null
  current: null | Fiber,
  // <App/>ì— ëŒ€ì‘ë˜ëŠ” Fiber
  workInProgress: Fiber,
  // App í•¨ìˆ˜
  Component: any,
  nextProps: any,
  renderLanes: Lanes,
) {
  let context;
  let nextChildren;
  let hasId;

  prepareToReadContext(workInProgress, renderLanes);

  // [!code highlight:8]
  nextChildren = renderWithHooks(
    current,
    workInProgress,
    Component,
    nextProps,
    context,
    renderLanes,
  );

  if (current !== null && !didReceiveUpdate) {
    bailoutHooks(current, workInProgress, renderLanes);
    return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
  }

  if (getIsHydrating() && hasId) {
    pushMaterializedTreeId(workInProgress);
  }

  // [!code highlight:4]
  // currentê°€ nullì´ë¯€ë¡œ ì´ë²ˆì—ëŠ” mountChildFibersê°€ í˜¸ì¶œëœë‹¤.
  reconcileChildren(current, workInProgress, nextChildren, renderLanes);
  // App í•˜ìœ„ì˜ divê°€ workInProgress.childë¡œ ì„¤ì •ë˜ì—ˆë‹¤.
  return workInProgress.child;
}
```

`renderWithHooks`ì˜ êµ¬í˜„ì€ í›…ì„ ì‚´í´ë´ì•¼í•˜ê¸°ì— ë‚˜ì¤‘ì— ì‚´í´ë³´ê² ì§€ë§Œ ì•„ë˜ì²˜ëŸ¼ ìš°ë¦¬ê°€ ë§Œë“  Component í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì´ ìˆìŒë§Œ ì§šê³  ë„˜ì–´ê°€ì. 

```js
let children = __DEV__
    ? callComponentInDEV(Component, props, secondArg)
    : Component(props, secondArg);
```

`nextChildren`ì„ ë¡œê·¸ ì°ì–´ë³´ë©´ ì•„ë˜ì™€ ê°™ìœ¼ë‹ˆ ì°¸ê³ . Appì˜ ë°˜í™˜ê°’ì— ìµœìƒë‹¨ divë¥¼ ë‚˜íƒ€ë‚´ëŠ” Elementê°€ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. divì˜ ìì‹ ìš”ì†Œë“¤ì€ props.childrenì— ë‹´ê²¨ìˆë‹¤.

```txt
{$$typeof: Symbol(react.transitional.element), type: 'div', key: null, props: {â€¦}, _owner: FiberNode,Â â€¦}
```

## reconcileChildren

ìµœì í™”ë¥¼ ìœ„í•´ ê¸°ì¡´ Fiber íŠ¸ë¦¬ì˜ ìœ ë¬´ì— ë”°ë¼ side effectë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸ë¥¼ ê¸°ë¡í• ì§€ ë§ì§€ ê²°ì •í•˜ëŠ” ë¶„ê¸°ê°€ ìˆìŒì„ ì‚´í´ë´¤ì—ˆë‹¤. 

App fiberì— í•´ë‹¹í•˜ëŠ” ê¸°ì¡´ Fiber ë…¸ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ì´ë²ˆì—ëŠ” `mountChildFibers`ê°€ í˜¸ì¶œë˜ì–´ ë”°ë¡œ ìˆ˜ì •ì‚¬í•­ì— ëŒ€í•œ í”Œë˜ê·¸ë¥¼ ê¸°ë¡í•˜ì§€ ì•ŠëŠ”ë‹¤ ğŸ‘

```js
export function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes,
) {
  if (current === null) {
    // [!code highlight:10]
    // If this is a fresh new component that hasn't been rendered yet, we
    // won't update its child set by applying minimal side-effects. Instead,
    // we will add them all to the child before it gets rendered. That means
    // we can optimize this reconciliation pass by not tracking side-effects.
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes,
    );
  } else {
   ...
  }
}
```

workInProgress.childëŠ” divì— í•´ë‹¹í•˜ëŠ” Fiberë¥¼ ê°€ë¦¬í‚¤ê²Œ ë˜ê³  ë‹¤ìŒ performUnitOfWorkì—ì„œëŠ” ì´ Fiberë¥¼ ì²˜ë¦¬í•  ê²ƒì´ë‹¤. 

`mountChildFibers`ì˜ ë‚´ë¶€ëŠ” ì§€ë‚œë²ˆê³¼ ìœ ì‚¬í•˜ë‹ˆ ë„˜ì–´ê°€ê³ , ë°˜í™˜ê°’ë§Œ ì°ì–´ë³´ì. 

```text
FiberNode {tag: 5, key: null, elementType: 'div', type: 'div',â€¦ }
```

ì§€ë‚œë²ˆì— App Fiber ë•Œì™€ëŠ” ë‹¤ë¥´ê²Œ tagê°€ ì´ë²ˆì—ëŠ” 0(FunctionComponent, App)ì´ ì•„ë‹ˆê³  5(HostComponent, div)ì„ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

## ë‚˜ë¨¸ì§€...

divì™€ pì— í•´ë‹¹í•˜ëŠ” Fiberë¥¼ ì²˜ë¦¬í•  ë•ŒëŠ” ê¸°ì¡´ê³¼ ìœ ì‚¬í•˜ë‹¤. `updateHostComponent`ë„ ê²°êµ­ `mountChildFibers`ì™€ `reconcileChildren`ì„ í˜¸ì¶œí•œë‹¤.

ë‹¤ë§Œ pë¥¼ ì²˜ë¦¬í•  ë•ŒëŠ” ë°°ì—´ì„ ìì‹ìœ¼ë¡œ ê°€ì§€ê¸°ì— `reconcileChildren` ë‚´ë¶€ì—ì„œ `reconcileChildrenArry`ê°€ í˜¸ì¶œë˜ëŠ”ë° ì´ê±´ `key`ì— ì—°ê´€ë˜ì–´ ëª©ì¡í•´ì§€ë¯€ë¡œ ë‹¤ìŒì— ì‚´í´ë³´ì. 

a, br, buttonì„ ì²˜ë¦¬í•  ë•Œ ëª¨ë‘ `updateHostComponent`ê°€ í˜¸ì¶œëœë‹¤. ë‹¤ë§Œ aì™€ button ëª¨ë‘ í…ìŠ¤íŠ¸ë¥¼ ìì‹ìœ¼ë¡œ ê°€ì§€ì§€ë§Œ ì²˜ë¦¬ê°€ ì¡°ê¸ˆì”© ë‹¤ë¥´ë‹ˆ ì´ ë¶€ë¶„ë§Œ í™•ì¸í•´ë³´ì. ì°¸ê³ ë¡œ ë‘ ë¶€ë¶„ì€ ê°ê° ì´ë ‡ê²Œ ìƒê²¼ì—ˆë‹¤:

```jsx
// a
<a href="https://yeolyi.com">yeolyi.com</a>

// button
<button onClick={() => setCount((count) => count + 1)}>
    click me - {count}
</button>
```

### í…ìŠ¤íŠ¸ ìì‹ì„ ê°€ì§„ ê²½ìš°

`workInProgress`ê°€ aì— í•´ë‹¹í•˜ëŠ” Fiberì¼ ë•Œ `workInProgress`ë¥¼ ì°ì–´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤:

```txt
FiberNode {
    ...
    pendingProps: {
        href: 'https://yeolyi.com',
        children: 'yeolyi.com'
    },
    ...
}
```

`updateHostComponent`ì—ì„œ ì´ Fiberë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì:

```js
function updateHostComponent(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
) {
  ...
  const type = workInProgress.type;
  const nextProps = workInProgress.pendingProps;
  const prevProps = current !== null ? current.memoizedProps : null;

  let nextChildren = nextProps.children;
  const isDirectTextChild = shouldSetTextContent(type, nextProps);

  if (isDirectTextChild) {
    // [!code highlight:5]
    // We special case a direct text child of a host node. This is a common
    // case. We won't handle it as a reified child. We will instead handle
    // this in the host environment that also has access to this prop. That
    // avoids allocating another HostText fiber and traversing it.
    nextChildren = null;
  } else {
    ...
  }

  ...
  reconcileChildren(current, workInProgress, nextChildren, renderLanes);
  return workInProgress.child;
}
```

ì£¼ì„ì´ ë§í•˜ëŠ”ëŒ€ë¡œ í…ìŠ¤íŠ¸ ìì‹ì„ ê°€ì§€ëŠ” ê²½ìš°ì—ëŠ” nextChildrenì„ nullë¡œ ì„¤ì •í•˜ê³  `reconcileChildren`ë¥¼ í˜¸ì¶œí•œë‹¤. 

### í…ìŠ¤íŠ¸ ìì‹ë“¤ì„ ê°€ì§€ëŠ” ê²½ìš°

`workInProgress`ê°€ buttonì— í•´ë‹¹í•˜ëŠ” Fiberì¼ ë•Œ `workInProgress`ë¥¼ ì°ì–´ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤:

```txt
FiberNode {
    ...
    pendingProps: {
        onClick: Æ’,
        children: ['click me - ', 0]
    },
    ...
}
```


`updateHostComponent`ì—ì„œëŠ” ì´ì „ì²˜ëŸ¼ `nextChildren`ì„ nullì²˜ë¦¬í•˜ì§€ ì•Šê³  ì´ ë°°ì—´ì„ `reconcileChildren`ì— ê±´ë„¤ì¤€ë‹¤. ì´í›„ ì•„ë˜ì™€ ê°™ì´ í…ìŠ¤íŠ¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” Fiberê°€ ë‘ ê°œ ë§Œë“¤ì–´ì§„ë‹¤:

```txt
FiberNode { tag: 6, pendingProps: "click me -"}
FiberNode { tag: 6, pendingProps: "0"}
```

ë‚˜ì¤‘ì— ì´ë“¤ Fiberë¥¼ ì²˜ë¦¬í•  ë•Œê°€ ë˜ë©´ `updateHostTest`ê°€ í˜¸ì¶œëœë‹¤. ì˜ì™¸ë¡œ `updateHostTest`ëŠ” ë³„ë‹¤ë¥¸ ì²˜ë¦¬ ì—†ì´ ê·¸ëƒ¥ ë¦¬í„´í•œë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì€ Commit phaseì—ì„œ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

```js
function updateHostText(current: null | Fiber, workInProgress: Fiber) {
  if (current === null) {
    tryToClaimNextHydratableTextInstance(workInProgress);
  }
  // Nothing to do here. This is terminal. We'll do the completion step
  // immediately after.
  return null;
}
```

ì´ë¥¼ í†µí•´ Fiber ìˆœíšŒ ìˆœì„œë¥¼ ë¡œê·¸ ì°ì–´ë´¤ì„ ë•Œ a í•˜ìœ„ì— Text FiberëŠ” ì—†ëŠ”ë° buttonì—ëŠ” ìˆëŠ” ì´ìœ ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.

```text
HostRootFiber
FunctionComponentFiber (App)
HostComponentFiber (div)
HostComponentFiber (p)
FunctionComponentFiber (Link)
// [!code highlight]
HostComponentFiber (a)
HostComponentFiber (br)
// [!code highlight:3]
HostComponentFiber (button)
HostTextFiber 
HostTextFiber 
```
