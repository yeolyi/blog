export const title = 'ë§Œë“  DOM í™”ë©´ì— ë°˜ì˜í•˜ê¸°'

ë“œë””ì–´ `<App/>`ì„ ë³´ê³  ë§Œë“  ìƒˆë¡œìš´ Fiber íŠ¸ë¦¬ê°€ `workInProgress`ì— ì™„ì„±ëë‹¤! 
ê° íŠ¸ë¦¬ ë…¸ë“œì— ì—°ê´€ëœ DOM ë…¸ë“œë„ `stateNode` í•„ë“œì— ì—°ê²°ë˜ìˆë‹¤.

ì´ì œ Commit phaseì—ì„œ ì´ê±¸ ì‹¤ì œ DOMì— ì ìš©í•˜ëŠ” ì‘ì—…ì„ í•´ì•¼í•œë‹¤. 

ê³¼ì •ì€ ë‚˜ì¤‘ì— ì•Œì•„ë³´ê² ì§€ë§Œ commit phaseì—ì„œëŠ” `commitMutationEffectsOnFiber`ê°€ ì‹¤í–‰ëœë‹¤ê³  í•œë‹¤. 
ì‹¤ì œë¡œ ì˜ˆì „ì— ì‚´í´ë³¸ ì½œ ìŠ¤íƒì„ ë³´ë©´ ì•„ë˜ ê²½ë¡œë¡œ í˜¸ì¶œëœë‹¤.

- performWorkUntilDeadline 
- performWorkOnRootViaSchedularTask
- performWorkOnRoot
- commitRootWhenReady
- commitRoot
- flushMutationEffects
- **commitMutationEffectsOnFiber**

## commitMutationEffectsOnFiber

í•¨ìˆ˜ë“¤ì— ìˆ¨ì´ ê°€ë¹ ì˜¤ì§€ë§Œ ë¬´ì‹œí•˜ê³  `commitMutationEffectsOnFiber`ë§Œ ì‚´í´ë³´ì. `finishedWork`ë¡œ 
HostRootFiberê°€ ë“¤ì–´ì˜¨ë‹¤.

```js
function commitMutationEffectsOnFiber(
  // [!code highlight:2]
  // workInProgress íŠ¸ë¦¬ì˜ Fiber ë…¸ë“œì´ë‹¤.
  finishedWork: Fiber,
  root: FiberRoot,
  lanes: Lanes,
) {
  ...
  switch (finishedWork.tag) {
    ...
    case FunctionComponent: {
      // [!code highlight:2]
      recursivelyTraverseMutationEffects(root, finishedWork, lanes);
      commitReconciliationEffects(finishedWork, lanes);
      ...
      break;
    }
    case HostRoot: {
      ...
      if (supportsResources) {
        ...
      } else {
        // [!code highlight:2]
        recursivelyTraverseMutationEffects(root, finishedWork, lanes);
        commitReconciliationEffects(finishedWork, lanes);
      }
      ...
      break;
    }
  }
  ...
}
```

ê³µí†µì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” `recursivelyTraverseMutationEffects`ì™€ `commitReconciliationEffects`ë¥¼ ì‚´í´ë³´ì. 

### recursivelyTraverseMutationEffects

ì‚­ì œë˜ì–´ì•¼í•  ìì‹ë…¸ë“œë“¤ì„ ì‚­ì œí•˜ê³  
ë‚¨ì€ ìì‹ ë…¸ë“œë“¤ì— ëŒ€í•´ `commitMutationEffectsOnFiber`ë¥¼ í˜¸ì¶œí•œë‹¤.

```js
function recursivelyTraverseMutationEffects(
  root: FiberRoot,
  parentFiber: Fiber,
  lanes: Lanes,
) {
  // [!code highlight:9]
  // ì‚­ì œí•´ì•¼í•  ìì‹ ë…¸ë“œë“¤ì„ ì‚­ì œí•œë‹¤.
  // ë¬¼ë¡  ì´ˆê¸° ë Œë”ì—ì„œ ì‚­ì œí•  ê²ƒì€ ì—†ë‹¤.
  const deletions = parentFiber.deletions;
  if (deletions !== null) {
    for (let i = 0; i < deletions.length; i++) {
      const childToDelete = deletions[i];
      commitDeletionEffects(root, parentFiber, childToDelete);
    }
  }

  if (
    parentFiber.subtreeFlags &
    (enablePersistedModeClonedFlag ? MutationMask | Cloned : MutationMask)
  ) {
    let child = parentFiber.child;
    // [!code highlight:5]
    // ìì‹ ë…¸ë“œë“¤ì„ ì²˜ë¦¬í•œë‹¤.
    while (child !== null) {
      commitMutationEffectsOnFiber(child, root, lanes);
      child = child.sibling;
    }
  }
}
```

í˜¸ì¶œëœ `commitMutationEffectsOnFiber`ì—ì„œë„ ì¬ê·€ì ìœ¼ë¡œ ë™ì¼í•œ ì‘ì—…ì„ í• í…Œë‹ˆ íŠ¹ì • ë…¸ë“œì— ëŒ€í•´ 
`recursivelyTraverseMutationEffects`ê°€ í˜¸ì¶œë˜ì—ˆë‹¤ë©´ í•´ë‹¹ ë…¸ë“œì™€ í›„ì† ë…¸ë“œë“¤ì— ëŒ€í•´ 
`commitDeletionEffects`ì™€ `commitReconciliationEffects`ì´ ëª¨ë‘ ì‹¤í–‰ë˜ì—ˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

### commitReconciliationEffects

`Placement` í”Œë˜ê·¸ê°€ ìˆë‹¤ë©´ ë…¸ë“œë¥¼ ì‚½ì…í•œë‹¤.

```js
function commitReconciliationEffects(
  finishedWork: Fiber,
  committedLanes: Lanes,
) {
  const flags = finishedWork.flags;
  if (flags & Placement) {
    commitHostPlacement(finishedWork);
    // Clear the "placement" from effect tag so that we know that this is
    // inserted, before any life-cycles like componentDidMount gets called.
    finishedWork.flags &= ~Placement;
  }
  if (flags & Hydrating) {
    ...
  }
}
```

ê¸°ì–µì„ ë”ë“¬ì–´ë³´ìë©´ Placement í”Œë˜ê·¸ëŠ” HostRootFiberë¥¼ ë§Œë“¤ ë•Œ `placeSingleChild`ì—ì„œ ì„¤ì •ë˜ì—ˆë‹¤. 
ë”°ë¼ì„œ ì´ˆê¸° ë Œë”ì—ì„œëŠ” HostRootFiberì— ëŒ€í•´ `commitHostPlacement`ì´ í˜¸ì¶œëœë‹¤.

```js
function placeSingleChild(newFiber: Fiber): Fiber {
  if (shouldTrackSideEffects && newFiber.alternate === null) {
    newFiber.flags |= Placement | PlacementDEV;
  }
  return newFiber;
}
```

`commitHostPlacement`ëŠ” ê°„ë‹¨í•˜ë‹¤.

```js
export function commitHostPlacement(finishedWork: Fiber) {
  try {
    // [!code highlight]
    commitPlacement(finishedWork);
  } catch (error) {
    captureCommitPhaseError(finishedWork, finishedWork.return, error);
  }
}
```

`commitPlacement`ì— ì‹¤ì œ ë¡œì§ì´ ìˆë‹¤. ë…¸ë“œë¥¼ ì‚½ì…í•  êµ¬ì²´ì ì¸ Fiberë¥¼ ì°¾ëŠ” ê²ƒì´ ì¸ìƒê¹Šë‹¤.

```js
// [!code highlight:2]
// finishedWorkëŠ” Appì— í•´ë‹¹í•˜ëŠ” FiberNodeì´ë‹¤.
function commitPlacement(finishedWork: Fiber): void {
  ...
  let hostParentFiber;
  let parentFiber = finishedWork.return;

  // [!code highlight:12]
  // Function Componentê°™ì€ê±´ ë¦¬ì•¡íŠ¸ì—ë§Œ ìˆì§€
  // ì‹¤ì œë¡œ DOMì—ëŠ” ì—†ìœ¼ë¯€ë¡œ ê±°ê¸°ì— DOM ë…¸ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ëŠ” ì—†ë‹¤. 
  // ë”°ë¼ì„œ ë…¸ë“œì˜ ë¶€ëª¨ë¥¼ ì°¾ì•„ ì˜¬ë¼ê°€ë©° HostComponent, HostRootê°™ì€ ë…¸ë“œë¥¼ ì°¾ëŠ”ë‹¤. 
  while (parentFiber !== null) {
    ...
    if (isHostParent(parentFiber)) {
      hostParentFiber = parentFiber;
      break;
    }
    parentFiber = parentFiber.return;
  }

  switch (hostParentFiber.tag) {
    ...
    case HostRoot: {
      // [!code highlight:2]
      // <div id="root"></div> ì´ë‹¤
      const parent: Container = hostParentFiber.stateNode.containerInfo;
      const before = getHostSibling(finishedWork);
      // [!code highlight:6]
      insertOrAppendPlacementNodeIntoContainer(
        finishedWork,
        before,
        parent,
        parentFragmentInstances,
      );
      break;
    }
    ...
  }
}
```

`HostParentFiber`ì˜ `containerInfo` í•„ë“œë¡œ ì°¾ì•„ë‚¸ `<div id="root"></div>`ì— `finishedWork`ì˜ `stateNode`ë¥¼ ì‚½ì…í•œë‹¤. 

```js
import {
  appendChildToContainer,
  insertInContainerBefore,
} from './ReactFiberConfig';

function insertOrAppendPlacementNodeIntoContainer(
  node: Fiber,
  before: ?Instance,
  parent: Container,
  parentFragmentInstances: null | Array<FragmentInstanceType>,
): void {
  const {tag} = node;
  const isHost = tag === HostComponent || tag === HostText;

  if (isHost) {
    const stateNode = node.stateNode;
    // [!code highlight:7]
    // ì•„ë˜ëŠ” ReactFiberConfigë¡œ react reconcilerì— ì „ë‹¬í•´ì¤€ 
    // DOM ê´€ë ¨ í•¨ìˆ˜ë“¤ì´ë‹¤.
    if (before) {
      insertInContainerBefore(parent, stateNode, before);
    } else {
      appendChildToContainer(parent, stateNode);
    }
    ...
    return;
  } else {
    ...
  }

}
```

ì´ë ‡ê²Œ ì´ˆê¸° ë Œë”ë¥¼ ë§ˆì³¤ë‹¤ ğŸ‰

í•˜ì§€ë§Œ ì´ˆê¸° ë Œë”ë§Œ í•„ìš”í•˜ë‹¤ë©´ ë¦¬ì•¡íŠ¸ê°€ ì•„ë‹Œ ì •ì  HTMLì„ ì¼ì„ ê²ƒì´ë‹¤. ë¦¬ì•¡íŠ¸ê°€ ë”ìš± ì˜ë¯¸ìˆì–´ì§€ëŠ” ìˆœê°„ì¸ 
'ìƒíƒœ ë³€ê²½ì— ì˜í•œ ë¦¬ë Œë”ë§' ê³¼ì •ì„ ì´ì–´ì„œ ì‚´í´ë³´ì.
